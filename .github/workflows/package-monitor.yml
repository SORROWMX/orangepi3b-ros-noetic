name: ðŸ“Š Daily Package Monitor & PR Updates

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 6:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  analyze-packages:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Analyze .deb packages
      id: analyze
      run: |
        # ÐŸÐ¾Ð´ÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð² pool
        DEB_COUNT=$(find debian/pool/main/arm64 -name "*.deb" 2>/dev/null | wc -l)
        echo "deb_count=$DEB_COUNT" >> $GITHUB_OUTPUT
        
        # ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€Ñ‹
        TOTAL_SIZE=$(du -sh . | cut -f1)
        echo "total_size=$TOTAL_SIZE" >> $GITHUB_OUTPUT
        
        # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ ÑÐ°Ð¼Ñ‹Ðµ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
        LARGEST_FILES=$(find debian/pool/main/arm64 -name "*.deb" -exec ls -lah {} \; 2>/dev/null | sort -k5 -hr | head -5 | awk '{print $9 " (" $5 ")"}')
        echo "largest_files<<EOF" >> $GITHUB_OUTPUT
        echo "$LARGEST_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ñƒ
        ARCHITECTURE=$(find debian/pool/main/arm64 -name "*.deb" -exec file {} \; 2>/dev/null | head -1 | grep -o 'arm64\|amd64\|i386' | head -1)
        echo "architecture=$ARCHITECTURE" >> $GITHUB_OUTPUT

    - name: Make scripts executable
      run: |
        chmod +x *.sh
        echo "âœ… Scripts made executable"

    - name: Check package status
      run: |
        echo "ðŸ“Š Checking package status..."
        ./check_packages.sh

    - name: Generate README
      run: |
        python3 generate_readme.py

    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain README.md)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git commit -m "ðŸ¤– Auto-update README

        ðŸ“¦ Package count: ${{ steps.analyze.outputs.deb_count }}
        ðŸ“ Repository size: ${{ steps.analyze.outputs.total_size }}
        ðŸ—ï¸ Architecture: ${{ steps.analyze.outputs.architecture }}
        â° Updated: $(date)"
        
        # Pull latest changes before pushing
        git pull --rebase origin main || git pull --rebase origin master
        git push

    - name: Create detailed summary
      run: |
        echo "## ðŸ“Š Package Analysis Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Package Statistics" >> $GITHUB_STEP_SUMMARY
        echo "- **Total .deb files:** ${{ steps.analyze.outputs.deb_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository size:** ${{ steps.analyze.outputs.total_size }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Architecture:** ${{ steps.analyze.outputs.architecture }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“ˆ Largest Files" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.analyze.outputs.largest_files }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
          echo "### âœ… Actions Taken" >> $GITHUB_STEP_SUMMARY
          echo "- README.md was updated" >> $GITHUB_STEP_SUMMARY
          echo "- Changes were committed and pushed" >> $GITHUB_STEP_SUMMARY
        else
          echo "### â„¹ï¸ Status" >> $GITHUB_STEP_SUMMARY
          echo "- No changes needed in README.md" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Create package list artifact
      if: always()
      run: |
        mkdir -p artifacts
        find debian/pool/main/arm64 -name "*.deb" -exec ls -la {} \; > artifacts/package_list.txt 2>/dev/null || echo "No .deb files found" > artifacts/package_list.txt
        echo "Generated on: $(date)" >> artifacts/package_list.txt
        echo "Total packages: ${{ steps.analyze.outputs.deb_count }}" >> artifacts/package_list.txt

    - name: Upload package list
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: package-list-${{ github.run_number }}
        path: artifacts/package_list.txt
