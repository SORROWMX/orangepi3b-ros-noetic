name: ðŸ“¦ Debian Repository Generator

on:
  push:
    branches: [ main, master ]
    paths:
      - '*.deb'
      - 'debian/**'
  workflow_dispatch:
  schedule:
    # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 7:00 UTC
    - cron: '0 7 * * *'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-repository:
    runs-on: ubuntu-latest
    environment: github-pages
    env:
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install required tools
      run: |
        sudo apt-get update
        sudo apt-get install -y dpkg-dev apt-utils gnupg2

    - name: Import GPG key
      if: env.GPG_PRIVATE_KEY != ''
      uses: crazy-max/ghaction-import-gpg@v6
      with:
        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
        passphrase: ${{ secrets.GPG_PASSPHRASE }}
        git_commit_gpgsign: true

    - name: Configure GPG key ID
      if: env.GPG_PRIVATE_KEY != ''
      run: |
        # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ GPG key ID Ð´Ð»Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸
        echo "default-key ${{ secrets.GPG_KEY_ID }}" >> ~/.gnupg/gpg.conf
        echo "ðŸ” GPG key configured: ${{ secrets.GPG_KEY_ID }}"

    - name: Create repository structure
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹
        mkdir -p debian/pool/main/arm64
        mkdir -p debian/dists/bookworm/main/binary-arm64
        
        echo "ðŸ“ Repository structure created"

    - name: Generate Packages file
      run: |
        cd debian
        # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Packages Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ ARM64
        dpkg-scanpackages -m pool/main/arm64 /dev/null | gzip -9c > dists/bookworm/main/binary-arm64/Packages.gz
        dpkg-scanpackages -m pool/main/arm64 /dev/null > dists/bookworm/main/binary-arm64/Packages
        
        echo "ðŸ“¦ Packages file generated"

    - name: Generate Release file
      run: |
        cd debian/dists/bookworm
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Release Ñ„Ð°Ð¹Ð»
        cat > Release << EOF
        Origin: Orange Pi 3B ROS Noetic Repository
        Label: Orange Pi 3B ROS Noetic
        Suite: bookworm
        Version: 12
        Codename: bookworm
        Date: $(date -R)
        Architectures: arm64
        Components: main
        Description: Pre-compiled ROS Noetic packages for Orange Pi 3B (ARM64)
        EOF
        
        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ MD5 ÑÑƒÐ¼Ð¼Ñ‹
        echo "MD5Sum:" >> Release
        find . -type f -name "Packages*" -exec md5sum {} \; | sed 's/^/ /' >> Release
        
        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ SHA256 ÑÑƒÐ¼Ð¼Ñ‹
        echo "SHA256:" >> Release
        find . -type f -name "Packages*" -exec sha256sum {} \; | sed 's/^/ /' >> Release
        
        echo "ðŸ“‹ Release file generated"

    - name: Sign Release file (if GPG available)
      if: env.GPG_PRIVATE_KEY != ''
      run: |
        cd debian/dists/bookworm
        
        # ÐŸÐ¾Ð´Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Release Ñ„Ð°Ð¹Ð»
        gpg --batch --yes --clearsign Release
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ InRelease Ñ„Ð°Ð¹Ð» (Ð¿ÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ Release.asc Ð² InRelease)
        mv Release.asc InRelease
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Release.gpg Ñ„Ð°Ð¹Ð»
        gpg --batch --yes --detach-sign --armor Release
        
        echo "ðŸ” Release file signed with GPG key: ${{ secrets.GPG_KEY_ID }}"

    - name: Count packages
      id: count
      run: |
        PACKAGE_COUNT=$(find debian/pool/main/arm64 -name "*.deb" | wc -l)
        echo "package_count=$PACKAGE_COUNT" >> $GITHUB_OUTPUT
        echo "ðŸ“Š Found $PACKAGE_COUNT packages"

    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain debian/)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add all changes
        git add debian/
        
        # Commit changes
        git commit -m "ðŸ¤– Auto-update Debian repository

        ðŸ“¦ Package count: ${{ steps.count.outputs.package_count }}
        ðŸ—ï¸ Architecture: ARM64
        ðŸ“… Updated: $(date '+%Y-%m-%d %H:%M:%S')
        ðŸ”„ Generated by: GitHub Actions"
        
        # Push changes
        git push

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Create summary
      run: |
        echo "## ðŸ—ï¸ Debian Repository Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Repository Statistics" >> $GITHUB_STEP_SUMMARY
        echo "- **Total packages:** ${{ steps.count.outputs.package_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Architecture:** ARM64" >> $GITHUB_STEP_SUMMARY
        echo "- **Distribution:** Debian Bookworm" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
          echo "### âœ… Actions Taken" >> $GITHUB_STEP_SUMMARY
          echo "- Repository metadata updated" >> $GITHUB_STEP_SUMMARY
          echo "- Packages file regenerated" >> $GITHUB_STEP_SUMMARY
          echo "- Release file updated" >> $GITHUB_STEP_SUMMARY
          echo "- Changes committed and pushed" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Pages deployed" >> $GITHUB_STEP_SUMMARY
        else
          echo "### â„¹ï¸ Status" >> $GITHUB_STEP_SUMMARY
          echo "- No changes needed in repository" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Repository URL" >> $GITHUB_STEP_SUMMARY
        echo "Your Debian repository will be available at:" >> $GITHUB_STEP_SUMMARY
        echo "\`https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/\`" >> $GITHUB_STEP_SUMMARY
