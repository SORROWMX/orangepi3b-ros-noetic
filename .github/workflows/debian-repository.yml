name: ðŸ“¦ Debian Repository Generator

on:
  push:
    branches: [ main, master ]
    paths:
      - '*.deb'
      - 'debian/**'
  workflow_dispatch:
  schedule:
    # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 7:00 UTC
    - cron: '0 7 * * *'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-repository:
    runs-on: ubuntu-latest
    environment: github-pages
    env:
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install required tools
      run: |
        sudo apt-get update
        sudo apt-get install -y dpkg-dev apt-utils gnupg2 bc

    - name: Import GPG key
      if: env.GPG_PRIVATE_KEY != ''
      uses: crazy-max/ghaction-import-gpg@v6
      with:
        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
        passphrase: ${{ secrets.GPG_PASSPHRASE }}
        git_commit_gpgsign: true

    - name: Configure GPG key ID
      if: env.GPG_PRIVATE_KEY != ''
      run: |
        # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ GPG key ID Ð´Ð»Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸
        echo "default-key ${{ secrets.GPG_KEY_ID }}" >> ~/.gnupg/gpg.conf
        echo "ðŸ” GPG key configured: ${{ secrets.GPG_KEY_ID }}"

    - name: Create repository structure
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹
        mkdir -p debian/pool/main/arm64
        mkdir -p debian/dists/bookworm/main/binary-arm64
        
        echo "ðŸ“ Repository structure created"

    - name: Generate Packages file
      run: |
        cd debian
        # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Packages Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ ARM64
        dpkg-scanpackages -m pool/main/arm64 /dev/null | gzip -9c > dists/bookworm/main/binary-arm64/Packages.gz
        dpkg-scanpackages -m pool/main/arm64 /dev/null > dists/bookworm/main/binary-arm64/Packages
        
        echo "ðŸ“¦ Packages file generated"

    - name: Generate packages.json for web interface
      run: |
        cd debian
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ packages.json Ð´Ð»Ñ Ð²ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ°
        echo "ðŸ“‹ Generating packages.json for web interface..."
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº .deb Ñ„Ð°Ð¹Ð»Ð¾Ð²
        DEB_FILES=$(find pool/main/arm64 -name "*.deb" | sort)
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ JSON ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ
        echo "{" > packages.json
        echo "  \"packages\": [" >> packages.json
        
        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ ÐºÐ°Ð¶Ð´Ð¾Ð¼ Ð¿Ð°ÐºÐµÑ‚Ðµ
        first=true
        for deb_file in $DEB_FILES; do
          if [ "$first" = true ]; then
            first=false
          else
            echo "," >> packages.json
          fi
          
          filename=$(basename "$deb_file")
          size=$(stat -c%s "$deb_file" 2>/dev/null || echo "0")
          size_mb=$(awk -v s="$size" 'BEGIN { printf "%.2f", s/1024/1024 }')
          
          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ Ð¿Ð°ÐºÐµÑ‚Ð°
          category="other"
          if [[ "$filename" =~ ros-core|ros-base|ros-comm|ros_ ]]; then
            category="core"
          elif [[ "$filename" =~ roscpp|rospy|rosgraph|rosmaster ]]; then
            category="communication"
          elif [[ "$filename" =~ msgs ]] && [[ ! "$filename" =~ dbgsym ]]; then
            category="messages"
          elif [[ "$filename" =~ tf ]] && [[ ! "$filename" =~ dbgsym ]]; then
            category="tf"
          elif [[ "$filename" =~ image|camera|opencv ]]; then
            category="image"
          elif [[ "$filename" =~ rosbag|roslaunch|roswtf ]]; then
            category="utilities"
          elif [[ "$filename" =~ dbgsym ]]; then
            category="debug"
          fi
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ð°
          description=""
          if [[ "$filename" =~ ros-core ]]; then
            description="Core ROS functionality"
          elif [[ "$filename" =~ ros-base ]]; then
            description="Base ROS installation"
          elif [[ "$filename" =~ ros-comm ]]; then
            description="ROS communication libraries"
          elif [[ "$filename" =~ roscpp ]]; then
            description="C++ client library for ROS"
          elif [[ "$filename" =~ rospy ]]; then
            description="Python client library for ROS"
          elif [[ "$filename" =~ tf ]]; then
            description="Transform library for ROS"
          elif [[ "$filename" =~ msgs ]]; then
            description="Message definitions for ROS"
          elif [[ "$filename" =~ dbgsym ]]; then
            description="Debug symbols"
          fi
          
          echo "    {" >> packages.json
          echo "      \"name\": \"$filename\"," >> packages.json
          echo "      \"size\": \"${size_mb} MB\"," >> packages.json
          echo "      \"size_bytes\": $size," >> packages.json
          echo "      \"category\": \"$category\"," >> packages.json
          echo "      \"description\": \"$description\"," >> packages.json
          echo "      \"url\": \"$filename\"" >> packages.json
          echo -n "    }" >> packages.json
        done
        
        echo "" >> packages.json
        echo "  ]," >> packages.json
        echo "  \"total_count\": $(echo "$DEB_FILES" | wc -l)," >> packages.json
        echo "  \"generated_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"," >> packages.json
        echo "  \"repository_url\": \"https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/debian/\"" >> packages.json
        echo "}" >> packages.json
        
        echo "âœ… packages.json generated with $(echo "$DEB_FILES" | wc -l) packages"

    - name: Generate Release file
      run: |
        cd debian

        # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ Release Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ apt-ftparchive (Ñ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð°Ð¼Ð¸ Ð¸ Ñ…ÐµÑˆÐ°Ð¼Ð¸)
        cat > apt-ftparchive-release.conf << 'EOF'
        APT::FTPArchive::Release::Origin "Orange Pi 3B ROS Noetic Repository";
        APT::FTPArchive::Release::Label "Orange Pi 3B ROS Noetic";
        APT::FTPArchive::Release::Suite "bookworm";
        APT::FTPArchive::Release::Version "12";
        APT::FTPArchive::Release::Codename "bookworm";
        APT::FTPArchive::Release::Architectures "arm64";
        APT::FTPArchive::Release::Components "main";
        APT::FTPArchive::Release::Description "Pre-compiled ROS Noetic packages for Orange Pi 3B (ARM64)";
        APT::FTPArchive::Release::Acquire-By-Hash "yes";
        EOF

        apt-ftparchive -c apt-ftparchive-release.conf release dists/bookworm > dists/bookworm/Release

        echo "ðŸ“‹ Release file generated via apt-ftparchive"

    - name: Sign Release file (if GPG available)
      if: env.GPG_PRIVATE_KEY != ''
      run: |
        cd debian

        # ÐŸÐ¾Ð´Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Release Ñ„Ð°Ð¹Ð» ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ Ð² InRelease Ð¸ Release.gpg
        gpg --batch --yes --clearsign -o dists/bookworm/InRelease dists/bookworm/Release
        gpg --batch --yes --detach-sign --armor -o dists/bookworm/Release.gpg dists/bookworm/Release

        echo "ðŸ” Release & InRelease signed with GPG key: ${{ secrets.GPG_KEY_ID }}"

    - name: Count packages
      id: count
      run: |
        PACKAGE_COUNT=$(find debian/pool/main/arm64 -name "*.deb" | wc -l)
        echo "package_count=$PACKAGE_COUNT" >> $GITHUB_OUTPUT
        echo "ðŸ“Š Found $PACKAGE_COUNT packages"

    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain debian/)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add all changes
        git add debian/
        
        # Commit changes
        git commit -m "ðŸ¤– Auto-update Debian repository

        ðŸ“¦ Package count: ${{ steps.count.outputs.package_count }}
        ðŸ—ï¸ Architecture: ARM64
        ðŸ“… Updated: $(date '+%Y-%m-%d %H:%M:%S')
        ðŸ”„ Generated by: GitHub Actions"
        
        # Rebase onto latest remote to avoid non-fast-forward rejections
        BRANCH=$(git branch --show-current || echo "main")
        echo "ðŸ”„ Rebase on latest origin/$BRANCH before push"
        git pull --rebase origin "$BRANCH" || true
        
        # Push changes
        git push origin HEAD:"$BRANCH"

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Create summary
      run: |
        echo "## ðŸ—ï¸ Debian Repository Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Repository Statistics" >> $GITHUB_STEP_SUMMARY
        echo "- **Total packages:** ${{ steps.count.outputs.package_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Architecture:** ARM64" >> $GITHUB_STEP_SUMMARY
        echo "- **Distribution:** Debian Bookworm" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
          echo "### âœ… Actions Taken" >> $GITHUB_STEP_SUMMARY
          echo "- Repository metadata updated" >> $GITHUB_STEP_SUMMARY
          echo "- Packages file regenerated" >> $GITHUB_STEP_SUMMARY
          echo "- Release file updated" >> $GITHUB_STEP_SUMMARY
          echo "- Changes committed and pushed" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Pages deployed" >> $GITHUB_STEP_SUMMARY
        else
          echo "### â„¹ï¸ Status" >> $GITHUB_STEP_SUMMARY
          echo "- No changes needed in repository" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Repository URL" >> $GITHUB_STEP_SUMMARY
        echo "Your Debian repository will be available at:" >> $GITHUB_STEP_SUMMARY
        echo "\`https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/\`" >> $GITHUB_STEP_SUMMARY
