name: Auto-rename packages for Debian Bookworm

on:
  push:
    branches: [ main, master ]
    paths:
      - '*.deb'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  rename-packages:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Check for focal packages
      id: check-focal
      run: |
        FOCAL_COUNT=$(ls *-0focal*.deb 2>/dev/null | wc -l)
        echo "focal_count=$FOCAL_COUNT" >> $GITHUB_OUTPUT
        echo "Found $FOCAL_COUNT packages with -0focal suffix"

    - name: Create backup
      if: steps.check-focal.outputs.focal_count > 0
      run: |
        echo "ðŸ“ Creating backup of original packages..."
        mkdir -p backup_original
        cp *.deb backup_original/
        echo "âœ… Backup created in backup_original/"

    - name: Rename packages
      if: steps.check-focal.outputs.focal_count > 0
      run: |
        echo "ðŸ”„ Renaming packages from -0focal to -0bookworm..."
        python3 rename_packages.py

    - name: Remove old focal packages
      if: steps.check-focal.outputs.focal_count > 0
      run: |
        echo "ðŸ—‘ï¸ Removing old -0focal packages..."
        FOCAL_FILES=$(ls *-0focal*.deb 2>/dev/null || true)
        if [ -n "$FOCAL_FILES" ]; then
          echo "Removing files:"
          echo "$FOCAL_FILES"
          rm *-0focal*.deb
          echo "âœ… Old focal packages removed"
        else
          echo "â„¹ï¸ No focal packages to remove"
        fi

    - name: Check for changes
      id: verify-changes
      run: |
        if [ -n "$(git status --porcelain *.deb)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "ðŸ“ Package files have been modified"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ No package changes needed"
        fi

    - name: Commit and push changes
      if: steps.verify-changes.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add *.deb
        git commit -m "ðŸ¤– Auto-rename packages for Debian Bookworm

        - Renamed packages from -0focal to -0bookworm
        - Created backup of original files
        - Optimized for Debian Bookworm (12)
        - Generated by: GitHub Actions"
        
        # Pull latest changes before pushing
        git pull --rebase origin main || git pull --rebase origin master
        git push

    - name: Create summary
      run: |
        echo "## ðŸ“¦ Package Renaming Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ÐŸÐ¾Ð´ÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹
        TOTAL_DEB=$(ls -1 *.deb 2>/dev/null | wc -l)
        BOOKWORM_DEB=$(ls -1 *-0bookworm*.deb 2>/dev/null | wc -l)
        FOCAL_DEB=$(ls -1 *-0focal*.deb 2>/dev/null | wc -l)
        
        echo "**Total .deb files:** $TOTAL_DEB" >> $GITHUB_STEP_SUMMARY
        echo "**Packages with -0bookworm:** $BOOKWORM_DEB" >> $GITHUB_STEP_SUMMARY
        echo "**Packages with -0focal:** $FOCAL_DEB" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.verify-changes.outputs.changed }}" == "true" ]; then
          echo "### âœ… Actions Taken" >> $GITHUB_STEP_SUMMARY
          echo "- Packages were renamed for Debian Bookworm compatibility" >> $GITHUB_STEP_SUMMARY
          echo "- Original files were backed up" >> $GITHUB_STEP_SUMMARY
          echo "- Changes were committed and pushed" >> $GITHUB_STEP_SUMMARY
        else
          echo "### â„¹ï¸ Status" >> $GITHUB_STEP_SUMMARY
          echo "- No package renaming needed" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload backup as artifact
      if: steps.check-focal.outputs.focal_count > 0
      uses: actions/upload-artifact@v4
      with:
        name: original-packages-backup
        path: backup_original/
        retention-days: 30
